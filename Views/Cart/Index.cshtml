@model web_quanao.Core.Entities.Cart
@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_LayoutHome.cshtml";
    var demoProducts = ViewBag.DemoProducts as (int id, string name, decimal price)[];
}
<h2>Giỏ hàng</h2>

@if (demoProducts != null)
{
    <div class="mb-4">
        <h4>Thêm nhanh sản phẩm demo</h4>
        @foreach (var p in demoProducts)
        {
            <button class="btn btn-sm btn-outline-light me-2 mb-2 add-demo"
                    data-id="@p.id"
                    data-name="@p.name"
                    data-price="@p.price">
                @p.name (@p.price.ToString("N0"))
            </button>
        }
    </div>
}

@if (Model == null || Model.Items == null || !Model.Items.Any())
{
    <p>Giỏ hàng trống.</p>
}
else
{
    <table class="table table-striped table-bordered align-middle table-dark">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Số lượng</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Items)
            {
                var price = item.Product?.DiscountPrice ?? item.Product?.Price ?? 0m;
                <tr data-item-id="@item.CartItemId">
                    <td>@item.Product?.ProductName</td>
                    <td style="width:160px;">
                        <div class="input-group">
                            <input type="number" class="form-control qty" value="@item.Quantity" min="1" />
                            <span class="input-group-btn">
                                <button class="btn btn-outline-secondary btn-update" type="button">Cập nhật</button>
                            </span>
                        </div>
                    </td>
                    <td>@price.ToString("N0")</td>
                    <td class="line-total">@(price * item.Quantity).ToString("N0")</td>
                    <td><button class="btn btn-danger btn-sm btn-remove">Xóa</button></td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3" class="text-end">Tổng</th>
                <th id="cart-total">@((decimal)ViewBag.Total).ToString("N0")</th>
                <th></th>
            </tr>
        </tfoot>
    </table>
}

@section scripts {
    <script>
(function(){
    function refreshTotal(){
        var total = 0;
        $('td.line-total').each(function(){
            var v = $(this).text().replace(/[^0-9]/g,'');
            total += parseInt(v || '0');
        });
        $('#cart-total').text(total.toLocaleString());
    }

    $('.btn-update').click(function(){
        var row = $(this).closest('tr');
        var id = row.data('item-id');
        var qty = parseInt(row.find('input.qty').val());
        if(qty <= 0) qty = 1;
        $.post('@Url.Action("Update","Cart")', { cartItemId:id, quantity:qty }, function(r){
            if(r.success){
                var priceText = row.find('td').eq(2).text().replace(/[^0-9]/g,'');
                var price = parseInt(priceText || '0');
                row.find('.line-total').text((price * qty).toLocaleString());
                refreshTotal();
            }
        });
    });

    $('.btn-remove').click(function(){
        var row = $(this).closest('tr');
        var id = row.data('item-id');
        $.post('@Url.Action("Remove","Cart")', { cartItemId:id }, function(r){
            if(r.success){
                row.remove();
                refreshTotal();
            }
        });
    });

    $('.add-demo').click(function(){
        var id = $(this).data('id');
        $.post('@Url.Action("Add","Cart")', { productId:id, quantity:1 }, function(r){
            if(r.success){
                location.reload();
            }
        });
    });
})();
    </script>
}
